{% extends 'dashboard/base_dashboard.html' %}
{% load humanize %}
{% load static %}

{% block title %}Tableau de Bord | {{ title }}{% endblock %}

{% block period_selector %}
<div class="dropdown">
    <button class="btn btn-white shadow-sm border dropdown-toggle" type="button" id="periodSelect" data-bs-toggle="dropdown">
        <i class="fas fa-calendar-alt me-2 text-primary"></i>
        {% if period == 'today' %}Aujourd'hui
        {% elif period == '7days' %}7 derniers jours
        {% elif period == '30days' %}30 derniers jours
        {% elif period == 'this_year' %}Cette année
        {% else %}Ce mois-ci{% endif %}
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
        <li><a class="dropdown-item" href="?period=today">Aujourd'hui</a></li>
        <li><a class="dropdown-item" href="?period=7days">7 derniers jours</a></li>
        <li><a class="dropdown-item" href="?period=this_month">Ce mois-ci</a></li>
        <li><a class="dropdown-item" href="?period=30days">30 derniers jours</a></li>
        <li><a class="dropdown-item" href="?period=this_year">Cette année</a></li>
    </ul>
</div>
{% endblock %}

{% block dashboard_content %}
<div class="mb-5">
    <div class="row g-4 d-none d-lg-flex">
        <div class="col-md-6 col-lg-3">
            <div class="card bg-success text-white shadow-lg h-100">
                <div class="card-body">
                    <h5 class="card-title fw-light small">Ventes (Période)</h5>
                    <p class="card-text h4 fw-bold">{{ total_revenue|intcomma }} Ar</p>
                    <span class="small opacity-75">Filtre actif</span>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card bg-info text-white shadow-lg h-100">
                <div class="card-body">
                    <h5 class="card-title fw-light small">Commandes</h5>
                    <p class="card-text h4 fw-bold">{{ total_orders }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card bg-warning text-dark shadow-lg h-100">
                <div class="card-body">
                    <h5 class="card-title fw-light small">Panier Moyen</h5>
                    <p class="card-text h4 fw-bold">{{ average_order_value|floatformat:0|intcomma }} Ar</p> 
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card bg-secondary text-white shadow-lg h-100">
                <div class="card-body">
                    <h5 class="card-title fw-light small">Utilisateurs</h5>
                    <p class="card-text h4 fw-bold">{{ total_users }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <div class="card shadow-lg h-100 border-0">
            <div class="card-header bg-white fw-bold h5">
                <i class="fas fa-chart-bar me-2 text-primary"></i> Tendances Ventes & Commandes
            </div>
            <div class="card-body">
                <canvas id="salesChart"></canvas> 
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-lg h-100 border-0">
            <div class="card-header bg-white fw-bold h5">
                <i class="fas fa-star me-2 text-warning"></i> Top 5 Produits
            </div>
            <div class="card-body">
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-lg h-100 border-0">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-warehouse me-2"></i> Stock Critique ({{ low_stock_count }})</h5>
                <a href="{% url 'store:low_stock_report' %}" class="btn btn-sm btn-light text-danger fw-bold shadow-sm">Voir Détails</a>
            </div>
            <div class="card-body">
                {% if low_stock_products %}
                <ul class="list-group list-group-flush">
                    {% for product in low_stock_products %}
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <a href="{% url 'admin:store_product_change' product.pk %}" class="text-decoration-none text-dark">{{ product.product_name }}</a>
                        <span class="badge bg-danger rounded-pill">{{ product.stock }} restants</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center py-4 text-muted"><p>Stock correct.</p></div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow-lg h-100 border-0">
            <div class="card-header bg-white fw-bold h5">
                <i class="fas fa-history me-2 text-primary"></i> Activité Récente
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle" style="font-size: 0.9rem;">
                        <thead class="table-light">
                            <tr>
                                <th>N° Cmd</th>
                                <th>Client</th>
                                <th>Statut</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td><a href="{% url 'admin:orders_order_change' order.pk %}" class="fw-bold text-primary">#{{ order.order_number }}</a></td>
                                <td class="text-muted">{{ order.full_name }}</td>
                                <td>
                                    <span class="badge {% if order.status == 'Completed' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ order.status }}
                                    </span>
                                </td>
                                <td class="text-end fw-bold">{{ order.order_total|intcomma }} Ar</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4">Aucune commande.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.dashboardData = {
        salesLabels: JSON.parse('{{ sales_labels_json|safe|default:"[]" }}'),
        salesData: JSON.parse('{{ sales_data_json|safe|default:"[]" }}'),
        ordersData: JSON.parse('{{ orders_data_json|safe|default:"[]" }}'),
        topLabels: JSON.parse('{{ top_products_labels_json|safe|default:"[]" }}'),
        topData: JSON.parse('{{ top_products_data_json|safe|default:"[]" }}')
    };
</script>
<script src="{% static 'dashboard/js/main_db.js' %}"></script>
{% endblock %}