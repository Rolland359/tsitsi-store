{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="ts-kpi-container mb-4">
        <div class="ts-kpi-wrapper">
            <div class="ts-kpi-card bg-primary text-white">
                <div class="card-body p-4 d-flex justify-content-between align-items-center">
                    <div class="ts-card-text">
                        <small class="text-uppercase fw-bold opacity-75 d-block mb-1" style="letter-spacing: 0.5px;">Total Articles</small>
                        <h2 class="mb-0 fw-bold display-6" id="kpi-total">{{ total_stock_sum }}</h2>
                    </div>
                    <i class="fas fa-boxes fa-3x opacity-25 me-1"></i>
                </div>
            </div>

            <div class="ts-kpi-card bg-danger text-white">
                <div class="card-body p-4 d-flex justify-content-between align-items-center">
                    <div class="ts-card-text">
                        <small class="text-uppercase fw-bold opacity-75 d-block mb-1" style="letter-spacing: 0.5px;">Rupture</small>
                        <h2 class="mb-0 fw-bold display-6" id="kpi-rupture">{{ out_of_stock_count }}</h2>
                    </div>
                    <i class="fas fa-exclamation-circle fa-3x opacity-25 me-1"></i>
                </div>
            </div>

            <div class="ts-kpi-card bg-warning text-dark">
                <div class="card-body p-4 d-flex justify-content-between align-items-center">
                    <div class="ts-card-text">
                        <small class="text-uppercase fw-bold opacity-75 d-block mb-1" style="letter-spacing: 0.5px;">Faible (< 5)</small>
                        <h2 class="mb-0 fw-bold display-6" id="kpi-faible">{{ low_stock_count }}</h2>
                    </div>
                    <i class="fas fa-layer-group fa-3x opacity-25 me-1"></i>
                </div>
            </div>
        </div>
        <div class="ts-scroll-hint d-md-none text-muted mt-1 pe-2 text-end">
            <small style="font-size: 0.75rem;">Glisser pour voir plus <i class="fas fa-arrow-right ms-1 anim-bounce-x"></i></small>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">üì¶ √âtat des Stocks</h5>
            <a href="{% url 'admin:store_product_changelist' %}" class="btn btn-sm btn-dark shadow-sm">Admin Complet</a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="stock-table">
                <thead class="bg-light">
                    <tr class="small text-uppercase fw-bold text-muted">
                        <th style="min-width: 250px;">Produit</th>
                        <th>Cat√©gorie</th>
                        <th class="text-center">Quantit√©</th>
                        <th class="text-center">Statut</th>
                        <th class="text-end px-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr id="product-row-{{ product.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if product.images %}
                                        <img src="{{ product.images.url }}" class="rounded shadow-sm" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                            <i class="fas fa-image text-muted opacity-50"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-bold text-dark" style="font-size: 0.9rem;">{{ product.product_name }}</div>
                                    <small class="text-muted">ID: #{{ product.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border fw-normal">
                                {{ product.category.name|default:"Non class√©" }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="fw-bold fs-5 stock-qty">{{ product.stock }}</span>
                        </td>
                        <td class="text-center">
                            <div class="status-badge-container">
                                {% if product.stock <= 0 %}
                                    <span class="badge bg-danger">√âpuis√©</span>
                                {% elif product.stock < 5 %}
                                    <span class="badge bg-warning text-dark">Faible</span>
                                {% else %}
                                    <span class="badge bg-success">Optimal</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-end px-4">
                            <div class="btn-group shadow-sm">
                                <button class="btn btn-sm btn-outline-primary edit-stock-btn" 
                                        data-id="{{ product.id }}" 
                                        data-name="{{ product.product_name }}" 
                                        data-stock="{{ product.stock }}">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <a href="{% url 'admin:store_product_change' product.id %}" class="btn btn-sm btn-outline-dark" target="_blank">
                                    <i class="fas fa-cog"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered shadow-lg">
        <div class="modal-content border-0">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold">Ajuster le stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="text-muted mb-1">Mise √† jour pour :</p>
                <h5 id="modalProductName" class="fw-bold text-primary mb-4"></h5>
                <form id="stockForm">
                    {% csrf_token %}
                    <input type="hidden" id="productId">
                    <div class="bg-light p-3 rounded-3 mb-4">
                        <label class="form-label d-block text-muted small text-uppercase fw-bold">Nouvelle Quantit√©</label>
                        <input type="number" id="newStockInput" class="form-control form-control-lg text-center fw-bold border-0 bg-transparent" required min="0">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow">
                        Confirmer la modification
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;">
    <div id="stockToast" class="toast align-items-center text-white bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i> Stock mis √† jour avec succ√®s !
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    /* --- CSS CARROUSEL --- */
    .ts-kpi-container { position: relative; width: 100%; }
    .ts-kpi-wrapper {
        display: flex; gap: 16px; overflow-x: auto;
        padding: 10px 10px 20px 10px; scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }
    .ts-kpi-wrapper::-webkit-scrollbar { display: none; }
    .ts-kpi-card {
        flex: 0 0 calc(75% - 16px); scroll-snap-align: center;
        border-radius: 16px; border: none; box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }
    .ts-kpi-card .card-body { padding: 1.5rem !important; }

    /* --- ANIMATIONS --- */
    .anim-bounce-x { animation: bounceX 1.5s infinite; }
    @keyframes bounceX { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }

    @media (min-width: 768px) {
        .ts-kpi-wrapper { display: grid; grid-template-columns: repeat(3, 1fr); overflow-x: visible; gap: 20px; }
        .ts-kpi-card { flex: none; width: 100%; }
        .ts-scroll-hint { display: none; }
    }

    .table thead th { border-bottom: 2px solid #f8f9fa; color: #6c757d; padding: 15px 10px; }
    .table tbody td { border-bottom: 1px solid #f8f9fa; padding: 12px 10px; }
    #newStockInput:focus { box-shadow: none; outline: none; }
</style>

<script>
let stockModal;
let stockToast;

document.addEventListener('DOMContentLoaded', function() {
    stockModal = new bootstrap.Modal(document.getElementById('stockModal'));
    stockToast = new bootstrap.Toast(document.getElementById('stockToast'));
});

document.querySelectorAll('.edit-stock-btn').forEach(button => {
    button.onclick = function() {
        document.getElementById('productId').value = this.dataset.id;
        document.getElementById('modalProductName').innerText = this.dataset.name;
        document.getElementById('newStockInput').value = this.dataset.stock;
        stockModal.show();
    };
});

document.getElementById('stockForm').onsubmit = function(e) {
    e.preventDefault();
    const id = document.getElementById('productId').value;
    const newStock = document.getElementById('newStockInput').value;

    fetch("{% url 'dashboard:update_stock_ajax' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ "id": id, "new_stock": newStock })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            stockModal.hide();
            // Optionnel : Recharger la page pour mettre √† jour les KPIs globaux
            // ou mettre √† jour le DOM manuellement ici.
            // Pour √™tre s√ªr que les compteurs en haut sont justes, le reload est plus simple:
            location.reload(); 
            // Si vous pr√©f√©rez sans reload, remplacez par : stockToast.show();
        } else {
            alert("Erreur: " + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
};
</script>
{% endblock %}